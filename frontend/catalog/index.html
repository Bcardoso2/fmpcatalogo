<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FMP REPASSES - Cat√°logo</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #0d5c3d;
            --primary-dark: #094a31;
            --primary-light: #10b981;
            --accent: #34d399;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #0f172a;
            --text-light: #64748b;
            --text-lighter: #94a3b8;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .hidden { display: none !important; }
        
        /* Header Ultra Moderno */
        .header {
            background: linear-gradient(135deg, #0d5c3d 0%, #115e3e 50%, #0a4a2f 100%);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 30px rgba(0,0,0,0.15);
        }
        
        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem 2rem;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
        }
        
        .logo-icon {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 900;
            font-size: 1.5rem;
            box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
            transition: transform 0.3s ease;
        }
        
        .logo-icon:hover {
            transform: translateY(-2px) scale(1.05);
        }
        
        .logo-text {
            font-size: 1.75rem;
            font-weight: 900;
            color: white;
            letter-spacing: -0.5px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1.25rem;
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 100px;
            padding: 0.75rem 1.5rem;
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .credits-amount {
            color: #fbbf24;
            font-weight: 700;
        }

        .btn-auth {
            background: white;
            color: var(--primary);
            padding: 0.875rem 2rem;
            border-radius: 100px;
            border: none;
            font-weight: 700;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-auth:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .btn-logout {
            background: rgba(239, 68, 68, 0.15);
            color: #fca5a5;
            padding: 0.625rem 1.25rem;
            border-radius: 100px;
            border: 1px solid rgba(239, 68, 68, 0.3);
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-logout:hover {
            background: #ef4444;
            color: white;
        }

        .nav {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-link {
            padding: 0.75rem 1.5rem;
            border-radius: 100px;
            text-decoration: none;
            color: rgba(255,255,255,0.85);
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .nav-link:hover, .nav-link.active {
            background: rgba(255,255,255,0.2);
            color: white;
            border-color: rgba(255,255,255,0.3);
        }
        
        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            display: block;
            font-size: 2rem;
            font-weight: 900;
            color: white;
            line-height: 1;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            display: block;
            font-size: 0.75rem;
            color: rgba(255,255,255,0.7);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 6rem 2rem;
        }

        .spinner {
            width: 56px;
            height: 56px;
            border: 5px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Filters Modernos */
        .filters {
            background: var(--surface);
            border-radius: 24px;
            padding: 2.5rem;
            margin-bottom: 3rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
        }
        
        .search-container {
            position: relative;
            margin-bottom: 2rem;
        }

        .search {
            width: 100%;
            padding: 1.25rem 1.5rem 1.25rem 4rem;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 100px;
            color: var(--text);
            font-size: 1rem;
            font-family: inherit;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .search:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(13, 92, 61, 0.1);
            background: white;
        }
        
        .search::placeholder {
            color: var(--text-lighter);
        }

        .search-icon {
            position: absolute;
            left: 1.5rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            pointer-events: none;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.25rem;
        }

        .select {
            width: 100%;
            padding: 1rem 1.25rem;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 16px;
            color: var(--text);
            font-size: 0.95rem;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(13, 92, 61, 0.1);
            background: white;
        }

        .results-info {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 2px solid #a7f3d0;
            border-radius: 16px;
            padding: 1.25rem;
            margin-top: 2rem;
            text-align: center;
            font-weight: 600;
            color: var(--primary-dark);
        }
        
        .results-info strong {
            color: var(--primary);
            font-weight: 800;
        }

        /* Event Groups */
        .event-section {
            margin-bottom: 4rem;
        }

        .event-banner {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-radius: 20px;
            padding: 2rem 2.5rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-lg);
        }

        .event-info h2 {
            font-size: 1.75rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .event-badge {
            background: white;
            color: var(--primary);
            padding: 0.625rem 1.5rem;
            border-radius: 100px;
            font-weight: 800;
            font-size: 1.125rem;
        }

        /* Cards Ultra Modernos */
        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }
        
        .card {
            background: var(--surface);
            border-radius: 24px;
            overflow: hidden;
            border: 1px solid var(--border);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow);
        }
        
        .card:hover {
            transform: translateY(-12px);
            box-shadow: var(--shadow-xl);
            border-color: var(--primary);
        }

        /* Gallery Premium */
        .gallery {
            position: relative;
            height: 320px;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        }
        
        .gallery-main {
            position: relative;
            height: 260px;
            cursor: pointer;
            overflow: hidden;
        }
        
        .gallery-main img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card:hover .gallery-main img {
            transform: scale(1.1);
        }
        
        .gallery-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(13, 92, 61, 0.95) 0%, rgba(9, 74, 49, 0.95) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.4s ease;
            color: white;
        }
        
        .gallery-main:hover .gallery-overlay {
            opacity: 1;
        }
        
        .gallery-icon {
            font-size: 3rem;
            margin-bottom: 0.75rem;
        }
        
        .gallery-text {
            font-size: 1rem;
            font-weight: 700;
        }

        .thumbs {
            display: flex;
            height: 60px;
            gap: 8px;
            padding: 8px;
            background: rgba(255,255,255,0.5);
        }
        
        .thumb {
            flex: 1;
            height: 44px;
            object-fit: cover;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }
        
        .thumb:hover {
            border-color: var(--primary);
            transform: scale(1.08);
        }
        
        .more-btn {
            flex: 1;
            height: 44px;
            background: rgba(13, 92, 61, 0.1);
            border: 3px solid var(--primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: var(--primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }
        
        .more-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.08);
        }

        .no-image {
            height: 320px;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-lighter);
        }
        
        .no-image-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        
        .no-image-text {
            font-size: 1rem;
            font-weight: 600;
        }

        /* Card Content */
        .content {
            padding: 2rem;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            gap: 1.5rem;
        }
        
        .title-section {
            flex: 1;
        }
        
        .title {
            font-size: 1.375rem;
            font-weight: 800;
            color: var(--text);
            line-height: 1.3;
            margin-bottom: 0.75rem;
        }
        
        .year-badge {
            display: inline-block;
            font-size: 0.875rem;
            font-weight: 800;
            color: var(--primary);
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 2px solid #a7f3d0;
            padding: 0.375rem 1rem;
            border-radius: 100px;
        }
        
        .badges {
            display: flex;
            flex-direction: column;
            gap: 0.625rem;
        }
        
        .badge {
            padding: 0.5rem 1.25rem;
            border-radius: 100px;
            font-size: 0.8125rem;
            font-weight: 800;
            text-align: center;
            white-space: nowrap;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(13, 92, 61, 0.25);
        }

        .price-box {
            margin-bottom: 1.5rem;
            text-align: center;
            padding: 2rem;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 2px solid #a7f3d0;
            border-radius: 20px;
        }
        
        .price {
            font-size: 2.25rem;
            font-weight: 900;
            color: var(--primary);
            letter-spacing: -1px;
        }

        .specs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        
        .spec {
            background: var(--bg);
            border: 2px solid var(--border);
            padding: 0.625rem 1.25rem;
            border-radius: 100px;
            font-size: 0.8125rem;
            color: var(--text-light);
            font-weight: 700;
        }

        .location {
            margin-bottom: 1.5rem;
            color: var(--text-light);
            font-size: 0.9375rem;
            font-weight: 600;
        }

        /* Actions */
        .actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.875rem;
        }
        
        .actions .btn-cta {
            grid-column: 1 / -1;
        }
        
        .btn {
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 16px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9375rem;
            text-align: center;
            font-family: inherit;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(13, 92, 61, 0.25);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(13, 92, 61, 0.35);
        }
        
        .btn-secondary {
            background: var(--bg);
            color: var(--primary);
            border: 2px solid var(--border);
            font-weight: 700;
        }
        
        .btn-secondary:hover {
            background: white;
            border-color: var(--primary);
        }
        
        .btn-cta {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.3);
            font-size: 1.0625rem;
        }
        
        .btn-cta:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 24px rgba(16, 185, 129, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.25);
        }
        
        .btn-warning:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(251, 191, 36, 0.35);
        }

        /* Modals */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(12px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-box {
            background: white;
            border-radius: 28px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .modal.active .modal-box {
            transform: scale(1);
        }
        
        .modal-header {
            padding: 2rem 2.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg);
        }
        
        .modal-title {
            font-size: 1.75rem;
            font-weight: 900;
            color: var(--primary);
        }
        
        .modal-close {
            background: white;
            border: 2px solid var(--border);
            font-size: 1.75rem;
            cursor: pointer;
            color: var(--text-light);
            padding: 0.5rem;
            border-radius: 12px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-weight: 700;
        }
        
        .modal-close:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }
        
        .modal-body {
            padding: 2.5rem;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.75rem;
        }
        
        .label {
            display: block;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 0.875rem;
            font-size: 0.9375rem;
        }
        
        .input {
            width: 100%;
            padding: 1.125rem 1.5rem;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 16px;
            color: var(--text);
            font-size: 1rem;
            font-family: inherit;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(13, 92, 61, 0.1);
            background: white;
        }

        .info-alert {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 1.5rem;
            border-radius: 20px;
            margin: 2rem 0;
            font-size: 0.9375rem;
            color: #92400e;
            line-height: 1.6;
            border: 2px solid #fcd34d;
            font-weight: 600;
        }

        /* Toast */
        #toastContainer {
            position: fixed;
            top: 2rem;
            right: 2rem;
            z-index: 9999;
        }
        
        .toast {
            background: white;
            border-radius: 20px;
            padding: 1.25rem 2rem;
            margin-bottom: 1rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 320px;
            max-width: 90vw;
            font-weight: 700;
            font-size: 0.9375rem;
        }
        
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .toast-success { 
            border-left: 6px solid var(--success);
            color: var(--success);
        }
        .toast-error { 
            border-left: 6px solid var(--danger);
            color: var(--danger);
        }
        
        /* Responsive */
        @media (min-width: 640px) {
            .grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 1280px) {
            .grid {
                grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div id="toastContainer"></div>

    <header class="header">
        <div class="header-container">
            <div class="header-top">
                <a href="/" class="logo">
                    <div class="logo-icon">F</div>
                    <div class="logo-text">FMP REPASSES</div>
                </a>

                <div class="header-actions">
                    <div class="user-badge hidden" id="userBadge">
                        <span id="userName"></span>
                        <span class="credits-amount" id="userCredits">0 cr√©ditos</span>
                        <button class="btn-logout" onclick="logout()">Sair</button>
                    </div>
                    <a href="login" class="btn-auth" id="btnLogin">Entrar</a>
                </div>
            </div>

            <nav class="nav" id="nav">
                <a href="/" class="nav-link active">Cat√°logo</a>
                <a href="propostas" class="nav-link">Propostas</a>
                <a href="recarga" class="nav-link">Recarregar</a>
                <a href="perfil" class="nav-link">Perfil</a>
            </nav>

            <div class="stats-bar">
                <div class="stat">
                    <span class="stat-value" id="totalVehicles">0</span>
                    <span class="stat-label">Ve√≠culos</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="font-weight: 600; color: var(--text-light); font-size: 1.125rem;">Carregando ve√≠culos...</p>
        </div>

        <div id="catalog" class="hidden">
            <div class="filters">
                <div class="search-container">
                    <svg class="search-icon" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <input type="text" class="search" id="search" placeholder="Buscar por marca, modelo...">
                </div>
                
                <div class="filters-grid">
                    <select class="select" id="categoryFilter">
                        <option value="all">Todas as Categorias</option>
                    </select>
                    
                    <select class="select" id="stateFilter">
                        <option value="all">Todos os Estados</option>
                    </select>
                    
                    <select class="select" id="eventFilter">
                        <option value="all">Todos os Eventos</option>
                    </select>

                    <select class="select" id="priceFilter">
                        <option value="all">Todos os Pre√ßos</option>
                        <option value="0-10000">At√© R$ 10.000</option>
                        <option value="10000-20000">R$ 10.000 - R$ 20.000</option>
                        <option value="20000-30000">R$ 20.000 - R$ 30.000</option>
                        <option value="30000-50000">R$ 30.000 - R$ 50.000</option>
                        <option value="50000-100000">R$ 50.000 - R$ 100.000</option>
                        <option value="100000-999999999">Acima de R$ 100.000</option>
                    </select>

                    <select class="select" id="sortFilter">
                        <option value="none">Ordenar por</option>
                        <option value="price-asc">Menor Pre√ßo</option>
                        <option value="price-desc">Maior Pre√ßo</option>
                        <option value="year-desc">Ano (Mais Novo)</option>
                        <option value="year-asc">Ano (Mais Antigo)</option>
                        <option value="km-asc">Menor KM</option>
                        <option value="km-desc">Maior KM</option>
                    </select>
                </div>

                <div class="results-info">
                    Mostrando <strong id="visibleCount">0</strong> de <strong id="totalCount">0</strong> ve√≠culos
                </div>
            </div>

            <div id="vehiclesGrid"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script>
        const APP_STATE = {
            vehicles: [],
            currentUser: null,
            isLoggedIn: false
        }

       const API_BASE = window.location.origin + '/api'

        async function loadVehicles() {
            try {
                const response = await fetch(`${API_BASE}/vehicles`, { credentials: 'include' })
                const data = await response.json()
                
                if (data.success) {
                    APP_STATE.vehicles = data.vehicles
                    populateFilters()
                    renderVehicles()
                    updateStats()
                } else {
                    showToast('Erro ao carregar ve√≠culos', 'error')
                }
            } catch (error) {
                console.error('Erro:', error)
                showToast('Erro ao conectar', 'error')
            } finally {
                document.getElementById('loading').classList.add('hidden')
                document.getElementById('catalog').classList.remove('hidden')
            }
        }

        async function checkAuth() {
            try {
                const response = await fetch(`${API_BASE}/auth/me`, { credentials: 'include' })
                const data = await response.json()
                
                if (data.success && data.user) {
                    APP_STATE.currentUser = data.user
                    APP_STATE.isLoggedIn = true
                }
                
                updateUserUI()
            } catch (error) {
                updateUserUI()
            }
        }

        function updateUserUI() {
            const badge = document.getElementById('userBadge')
            const btn = document.getElementById('btnLogin')
            const nav = document.getElementById('nav')
            
            if (APP_STATE.isLoggedIn && APP_STATE.currentUser) {
                badge.classList.remove('hidden')
                btn.classList.add('hidden')
                nav.classList.remove('hidden')
                document.getElementById('userName').textContent = APP_STATE.currentUser.name
                document.getElementById('userCredits').textContent = `${parseFloat(APP_STATE.currentUser.credits).toFixed(1)} cr√©ditos`
            } else {
                badge.classList.add('hidden')
                btn.classList.remove('hidden')
                nav.classList.add('hidden')
            }
        }

        function populateFilters() {
            const categoryFilter = document.getElementById('categoryFilter')
            const stateFilter = document.getElementById('stateFilter')
            const eventFilter = document.getElementById('eventFilter')
            
            const categories = [...new Set(APP_STATE.vehicles.map(v => v.vehicle_data?.vehicle?.category_name).filter(Boolean))].sort()
            const states = [...new Set(APP_STATE.vehicles.map(v => v.vehicle_data?.shop_stock?.state).filter(Boolean))].sort()
            const events = [...new Set(APP_STATE.vehicles.map(v => {
                const fd = v.vehicle_data?.negotiation?.finish_date_display
                return fd ? fd.split(' ')[0] : null
            }).filter(Boolean))].sort((a,b) => new Date(b) - new Date(a))
            
            categories.forEach(c => {
                const opt = document.createElement('option')
                opt.value = c
                opt.textContent = c
                categoryFilter.appendChild(opt)
            })
            
            states.forEach(s => {
                const opt = document.createElement('option')
                opt.value = s
                opt.textContent = s
                stateFilter.appendChild(opt)
            })
            
            events.forEach(e => {
                const [y,m,d] = e.split('-')
                const opt = document.createElement('option')
                opt.value = e
                opt.textContent = `${d}/${m}/${y}`
                eventFilter.appendChild(opt)
            })
        }

        function renderVehicles() {
            const grid = document.getElementById('vehiclesGrid')
            grid.innerHTML = ''
            
            let filtered = [...APP_STATE.vehicles]
            
            const categoryFilter = document.getElementById('categoryFilter').value
            const stateFilter = document.getElementById('stateFilter').value
            const eventFilter = document.getElementById('eventFilter').value
            
            if (categoryFilter !== 'all') {
                filtered = filtered.filter(v => v.vehicle_data?.vehicle?.category_name === categoryFilter)
            }
            
            if (stateFilter !== 'all') {
                filtered = filtered.filter(v => v.vehicle_data?.shop_stock?.state === stateFilter)
            }
            
            if (eventFilter !== 'all') {
                filtered = filtered.filter(v => {
                    const fd = v.vehicle_data?.negotiation?.finish_date_display
                    return fd && fd.split(' ')[0] === eventFilter
                })
            }
            
            const grouped = {}
            filtered.forEach(v => {
                const fd = v.vehicle_data?.negotiation?.finish_date_display
                const date = fd ? fd.split(' ')[0] : 'sem-data'
                if (!grouped[date]) grouped[date] = []
                grouped[date].push(v)
            })
            
            const sorted = Object.keys(grouped).sort((a,b) => {
                if (a === 'sem-data') return 1
                if (b === 'sem-data') return -1
                return new Date(b) - new Date(a)
            })
            
            sorted.forEach(date => {
                const section = document.createElement('div')
                section.className = 'event-section'
                
                let formatted
                if (date === 'sem-data') {
                    formatted = 'Sem data definida'
                } else {
                    const [y,m,d] = date.split('-')
                    formatted = `${d}/${m}/${y}`
                }
                
                section.innerHTML = `
                    <div class="event-banner">
                        <div class="event-info">
                            <h2>Evento: ${formatted}</h2>
                        </div>
                        <div class="event-badge">${grouped[date].length}</div>
                    </div>
                    <div class="grid" id="grid-${date}"></div>
                `
                
                grid.appendChild(section)
                
                const subgrid = document.getElementById(`grid-${date}`)
                grouped[date].forEach((v, i) => {
                    const idx = APP_STATE.vehicles.indexOf(v)
                    subgrid.appendChild(createCard(v, idx))
                })
            })
            
            updateVisibleCount(filtered.length)
        }

        function createCard(v, idx) {
            const card = document.createElement('div')
            card.className = 'card'
            card.setAttribute('data-index', idx)
            
            const imgs = v.images || []
            const hasImgs = imgs.length > 0
            
            card.innerHTML = `
                <div class="gallery">
                    ${hasImgs ? `
                        <div class="gallery-main" onclick="openGallery(${idx})">
                            <img src="${imgs[0].url}" alt="${v.brand} ${v.model}">
                            <div class="gallery-overlay">
                                <div class="gallery-icon">üîç</div>
                                <div class="gallery-text">Ver ${imgs.length} foto${imgs.length>1?'s':''}</div>
                            </div>
                        </div>
                        ${imgs.length > 1 ? `
                            <div class="thumbs">
                                ${imgs.slice(1,4).map((img,i) => `<img class="thumb" src="${img.thumb||img.url}" onclick="openGallery(${idx},${i+1})">`).join('')}
                                ${imgs.length > 4 ? `<div class="more-btn" onclick="openGallery(${idx})">+${imgs.length-4}</div>` : ''}
                            </div>
                        ` : ''}
                    ` : `
                        <div class="no-image">
                            <div class="no-image-icon">üì∑</div>
                            <div class="no-image-text">Sem Imagem</div>
                        </div>
                    `}
                </div>

                <div class="content">
                    <div class="card-header">
                        <div class="title-section">
                            <h3 class="title">${v.brand} ${v.model}</h3>
                            <div class="year-badge">${v.year}</div>
                        </div>
                        <div class="badges">
                            <span class="badge">${v.vehicle_data?.vehicle?.category_name||'N/A'}</span>
                        </div>
                    </div>

                    <div class="price-box">
                        <div class="price">R$ ${formatPrice(v.price)}</div>
                    </div>

                    <div class="specs">
                        <span class="spec">${formatNumber(v.mileage)} km</span>
                        <span class="spec">${v.fuel_type||'N/A'}</span>
                        <span class="spec">${v.transmission||'Manual'}</span>
                    </div>

                    <div class="location">${v.location||'Localiza√ß√£o n√£o informada'}</div>

                    <div class="actions">
                        <button class="btn btn-primary" onclick="openDetails(${idx})">Ver Detalhes</button>
                        <button class="btn btn-secondary" onclick="openGallery(${idx})">Fotos (${imgs.length})</button>
                        ${v.laudo_file_url ? `<button class="btn btn-warning" onclick="window.open('${v.laudo_file_url}','_blank')">Ver Laudo</button>` : ''}
                        <button class="btn btn-cta" onclick="handleProposal(${idx})">Fazer Proposta</button>
                    </div>
                </div>
            `
            
            return card
        }

        function formatPrice(p) {
            return parseFloat(p||0).toLocaleString('pt-BR', {minimumFractionDigits:2})
        }

        function formatNumber(n) {
            return parseInt(n||0).toLocaleString('pt-BR')
        }

        function updateStats() {
            document.getElementById('totalVehicles').textContent = APP_STATE.vehicles.length
        }

        function updateVisibleCount(c) {
            document.getElementById('visibleCount').textContent = c
            document.getElementById('totalCount').textContent = APP_STATE.vehicles.length
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('search').addEventListener('input', e => {
                const q = e.target.value.toLowerCase()
                document.querySelectorAll('.card').forEach(card => {
                    const idx = parseInt(card.getAttribute('data-index'))
                    const v = APP_STATE.vehicles[idx]
                    const txt = `${v.brand} ${v.model} ${v.description||''} ${v.color||''}`.toLowerCase()
                    card.style.display = txt.includes(q) ? '' : 'none'
                })
            })
            
            document.getElementById('categoryFilter').addEventListener('change', renderVehicles)
            document.getElementById('stateFilter').addEventListener('change', renderVehicles)
            document.getElementById('eventFilter').addEventListener('change', renderVehicles)
        })

        async function handleProposal(idx) {
            const v = APP_STATE.vehicles[idx]
            
            if (!APP_STATE.isLoggedIn) {
                showToast('Fa√ßa login para fazer propostas', 'error')
                setTimeout(() => window.location.href = 'login', 1500)
                return
            }
            
            if (!APP_STATE.currentUser.cpf) {
                showToast('Complete seu cadastro', 'error')
                setTimeout(() => window.location.href = 'perfil', 1500)
                return
            }
            
            if (APP_STATE.currentUser.credits < 1) {
                showToast('Cr√©ditos insuficientes', 'error')
                setTimeout(() => window.location.href = 'recarga', 1500)
                return
            }
            
            openProposalModal(v)
        }

        function openProposalModal(v) {
            createModal('Fazer Proposta', `
                <div style="text-align: center;">
                    <h3 style="margin-bottom: 1rem; font-size: 1.25rem;">${v.brand} ${v.model} ${v.year}</h3>
                    <p style="font-size: 1.5rem; color: var(--success); font-weight: 800; margin: 1.5rem 0;">
                        Pre√ßo: R$ ${formatPrice(v.price)}
                    </p>
                    
                    <form id="proposalForm" onsubmit="submitProposal(event,'${v.external_id}')">
                        <div class="form-group">
                            <label class="label">Valor da Proposta *</label>
                            <input type="number" id="proposalValue" class="input" placeholder="0.00" step="0.01" min="1" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="label">Seu Nome *</label>
                            <input type="text" id="clientName" class="input" value="${APP_STATE.currentUser.name}" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="label">Seu Telefone *</label>
                            <input type="tel" id="clientPhone" class="input" value="${APP_STATE.currentUser.phone}" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="label">Seu Email (opcional)</label>
                            <input type="email" id="clientEmail" class="input" value="${APP_STATE.currentUser.email||''}" placeholder="seu@email.com">
                        </div>
                        
                        <div class="info-alert">
                            <strong>Aten√ß√£o:</strong> Esta proposta consumir√° <strong>1 cr√©dito (R$ 1.000,00)</strong> do seu saldo.<br>
                            Saldo atual: <strong>${parseFloat(APP_STATE.currentUser.credits).toFixed(1)} cr√©ditos</strong>
                        </div>
                        
                        <button type="submit" class="btn btn-cta" style="width:100%">Enviar Proposta (1 cr√©dito)</button>
                    </form>
                </div>
            `)
        }

        async function submitProposal(e, extId) {
            e.preventDefault()
            
            const btn = e.target.querySelector('button[type="submit"]')
            btn.disabled = true
            btn.textContent = 'Enviando...'
            
            try {
                const res = await fetch(`${API_BASE}/proposals`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({
                        vehicle_external_id: extId,
                        proposal_amount: parseFloat(document.getElementById('proposalValue').value),
                        customer_name: document.getElementById('clientName').value,
                        customer_phone: document.getElementById('clientPhone').value,
                        customer_email: document.getElementById('clientEmail').value || null
                    })
                })
                
                const data = await res.json()
                
                if (data.success) {
                    APP_STATE.currentUser.credits = data.remaining_credits
                    updateUserUI()
                    closeAllModals()
                    showToast('Proposta enviada!', 'success')
                } else {
                    showToast(data.error||'Erro', 'error')
                    btn.disabled = false
                    btn.textContent = 'Enviar Proposta (1 cr√©dito)'
                }
            } catch (error) {
                showToast('Erro ao conectar', 'error')
                btn.disabled = false
                btn.textContent = 'Enviar Proposta (1 cr√©dito)'
            }
        }

        function openDetails(idx) {
            const v = APP_STATE.vehicles[idx]
            
            createModal(`${v.brand} ${v.model}`, `
                <div style="background: var(--bg); padding: 2rem; border-radius: 20px;">
                    <h4 style="margin-bottom: 1.5rem; color: var(--primary); font-weight: 800; font-size: 1.25rem;">Informa√ß√µes do Ve√≠culo</h4>
                    
                    <p style="margin-bottom: 0.75rem;"><strong>Marca/Modelo:</strong> ${v.brand} ${v.model}</p>
                    <p style="margin-bottom: 0.75rem;"><strong>Ano:</strong> ${v.year}</p>
                    <p style="margin-bottom: 0.75rem;"><strong>Quilometragem:</strong> ${formatNumber(v.mileage)} km</p>
                    <p style="margin-bottom: 0.75rem;"><strong>Combust√≠vel:</strong> ${v.fuel_type||'N/A'}</p>
                    <p style="margin-bottom: 0.75rem;"><strong>Transmiss√£o:</strong> ${v.transmission||'Manual'}</p>
                    <p style="margin-bottom: 0.75rem;"><strong>Cor:</strong> ${v.color||'N/A'}</p>
                    <p style="margin-bottom: 0.75rem;"><strong>Pre√ßo:</strong> R$ ${formatPrice(v.price)}</p>
                    <p style="margin-bottom: 0.75rem;"><strong>Localiza√ß√£o:</strong> ${v.location||'N/A'}</p>
                    
                    ${v.description ? `
                        <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--border);">
                            <h4 style="margin-bottom: 1rem; color: var(--primary); font-weight: 800;">Descri√ß√£o</h4>
                            <p style="color: var(--text-light); line-height: 1.7;">${v.description}</p>
                        </div>
                    ` : ''}
                </div>
            `)
        }

        function openGallery(idx, start=0) {
            const v = APP_STATE.vehicles[idx]
            const imgs = v.images || []
            
            if (imgs.length === 0) {
                showToast('Nenhuma imagem', 'error')
                return
            }
            
            let cur = start
            
            createModal(`${v.brand} ${v.model} - Galeria`, `
                <div id="galleryContent" style="text-align: center;">
                    <img id="galleryImage" src="${imgs[cur].url}" style="max-width: 100%; max-height: 60vh; border-radius: 20px;">
                    <p style="margin-top: 1.5rem; color: var(--text-light); font-weight: 700; font-size: 1.125rem;">
                        Foto ${cur+1} de ${imgs.length}
                    </p>
                    ${imgs.length > 1 ? `
                        <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem;">
                            <button class="btn btn-secondary" onclick="changeGalleryImg(-1)">‚Üê Anterior</button>
                            <button class="btn btn-secondary" onclick="changeGalleryImg(1)">Pr√≥xima ‚Üí</button>
                        </div>
                    ` : ''}
                </div>
            `)
            
            window.changeGalleryImg = (dir) => {
                cur += dir
                if (cur < 0) cur = imgs.length - 1
                if (cur >= imgs.length) cur = 0
                
                document.getElementById('galleryImage').src = imgs[cur].url
                document.querySelector('#galleryContent p').textContent = `Foto ${cur+1} de ${imgs.length}`
            }
        }

        function createModal(title, content) {
            const modal = document.createElement('div')
            modal.className = 'modal'
            modal.innerHTML = `
                <div class="modal-box">
                    <div class="modal-header">
                        <h2 class="modal-title">${title}</h2>
                        <button class="modal-close" onclick="closeModal(this)">&times;</button>
                    </div>
                    <div class="modal-body">${content}</div>
                </div>
            `
            
            document.body.appendChild(modal)
            setTimeout(() => modal.classList.add('active'), 10)
            
            modal.addEventListener('click', e => {
                if (e.target === modal) closeModal(modal.querySelector('.modal-close'))
            })
            
            return modal
        }

        function closeModal(btn) {
            const modal = btn.closest('.modal')
            modal.classList.remove('active')
            setTimeout(() => modal.remove(), 300)
        }

        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(m => {
                m.classList.remove('active')
                setTimeout(() => m.remove(), 300)
            })
        }

        async function logout() {
            try {
                await fetch(`${API_BASE}/auth/logout`, {method: 'POST', credentials: 'include'})
                APP_STATE.currentUser = null
                APP_STATE.isLoggedIn = false
                updateUserUI()
                showToast('Logout realizado', 'success')
            } catch (error) {
                console.error(error)
            }
        }

        function showToast(msg, type='success') {
            const container = document.getElementById('toastContainer')
            const toast = document.createElement('div')
            toast.className = `toast toast-${type}`
            toast.textContent = msg
            container.appendChild(toast)
            
            setTimeout(() => {
                toast.style.opacity = '0'
                toast.style.transform = 'translateX(400px)'
                setTimeout(() => toast.remove(), 300)
            }, 3000)
        }

        window.addEventListener('DOMContentLoaded', () => {
            checkAuth().then(() => loadVehicles())
        })
    </script>
</body>
</html>
